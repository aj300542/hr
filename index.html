<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¯ä¸Šä¼ ç…§ç‰‡çš„å·¥ç‰Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="js/styles.css">
    <script src="js/wakelock.js"></script>
    <link rel="shortcut icon" href="js/ming.ico">
    <style>
    </style>
</head>

<body>
    <div id="badgeContainer">
        <div class="badge" style="position: relative;">
            <div class="photo-frame" id="frame">

                <img id="preview" style="display: none;" />
                <span id="uploadPrompt">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç…§ç‰‡</span>
                <input type="file" accept="image/*" onchange="previewPhoto(event)" />

            </div>

            <div class="info">
                <div class="line name" id="displayName">å°å¤©æ‰äºŒå·</div>
                <div class="line id" id="displayId">ç¼–å·ï¼š88888</div>
                <div class="line dept" id="displayDept">ç ”ç©¶éƒ¨ / å®éªŒç‰©å“</div>
            </div>
            <!-- ç»˜å›¾å±‚ -->
            <canvas id="iconCanvas"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: auto;"></canvas>
        </div>
    </div>
    <div class="buttonRow">
        <button class="actionBtn" onclick="refreshCanvas()">ğŸ”„åˆ·æ–°ç”»å¸ƒ</button>
        <button class="actionBtn" onclick="saveSceneAsFile()">ğŸ–¥ï¸ä¿å­˜åœºæ™¯</button>
        <label for="fileInput" class="actionBtn">ğŸ’½è½½å…¥åœºæ™¯</label>
        <input type="file" id="fileInput" accept=".json" onchange="loadSceneFromFile(event)" style="display:none;" />
    </div>

    <div class="buttonRow">
        <button class="actionBtn" onclick="fillFunnyInfo()">ğŸ”åˆ›æ„å¡«å……</button>
        <button class="actionBtn" onclick="updateInfo()">â˜•è¾“å…¥ä¿¡æ¯</button>
        <button class="actionBtn" onclick="downloadBadge()">ğŸ§‹ä¸‹è½½å›¾ç‰‡</button>
    </div>

    <div class="buttonRow">
        <button class="actionBtn" id="pasteBtn">ğŸ“‘ç²˜è´´emoji</button>
        <button class="actionBtn" id="sendToBackBtn">ğŸ“¥ç½®äºåº•å±‚</button>
        <button class="actionBtn" id="bringToFrontBtn">ğŸï¸ç…§ç‰‡åˆ‡æ¢</button>
    </div>

    <div class="buttonRow">
        <button class="actionBtn" id="undoBtn">â¬…ï¸ä¸Šä¸€æ­¥</button>
        <button class="actionBtn" id="redoBtn">â¡ï¸ä¸‹ä¸€æ­¥</button>
    </div>


    <div class="sceneLoaderPanel">
        <button onclick="loadSceneByName('ape')">ğŸµåŠ¨ç‰©</button>
        <button onclick="loadSceneByName('food')">ğŸ°ç¾é£Ÿ</button>
        <button onclick="loadSceneByName('drink')">ğŸ¸é¥®æ–™</button>
        <button onclick="loadSceneByName('ufo')">ğŸ›¸å¤ªç©º</button>
        <button onclick="loadSceneByName('music')">ğŸï¸éŸ³ä¹</button>
        <button onclick="loadSceneByName('culture')">ğŸªæ–‡åŒ–</button>
        <button id="material">ğŸ¤ªç´ æ</button>
        <button id="aj300">ğŸšæèµ </button>
    </div>
    <div id="consolePanel"></div>

    <script>
        window.elements = window.elements || [];
        window.groupElements = window.groupElements || [];

        let globalStep = 0;

        // ğŸ§± åˆå§‹åŒ–æ‰€æœ‰å…ƒç´ 
        elements.forEach(el => {
            el.rotationBase = 0;   // ç”±æ—‹è½¬æ§åˆ¶
            el.rotationSwing = 0;  // ç”±æ‘‡æ‘†æ§åˆ¶
            el.rotation = 0;       // æ€»åˆç”¨äºç»˜åˆ¶ï¼ˆå¯é€‰ï¼‰
        });
        groupElements.forEach(group => {
            group.rotationBase = 0;
            group.rotationSwing = 0;
            group.rotation = 0;
            group.isSwinging = false;
            group.isMoving = false;
            group.animationHandle = null;
            group.name = group.name || `Group_${Date.now()}`; // å¦‚æœéœ€è¦è°ƒè¯•å‘½å
            // ğŸ†• åŠ å…¥ä¸‹é¢è¿™ä¸¤è¡Œï¼š
            group.swingStep = 0;
            group.swingDirection = 1;
        });
    </script>

    </script>
    <script src="js/info.js"></script>
    <script src="js/history.js"></script>
    <script src="js/saveLoad.js"></script>
    <script src="js/drawing.js"></script>
    <script type="module" src="js/interaction.js"></script>
    <script src="js/animation.js"></script>

    <script>
        function refreshCanvas() {
            stopAllAnimations(); // âœ… æ¸…é™¤æ—§åŠ¨ç”»
            clearCanvas(); // æ¸…ç©ºç”»å¸ƒ
            if (typeof setScene === "function" && Array.isArray(window.elements)) {
                setScene(window.elements); // é‡æ–°ç»˜åˆ¶å½“å‰å…ƒç´ 
                console.log("âœ… ç”»å¸ƒå·²åˆ·æ–°");
            } else {
                console.warn("âš ï¸ æ— æ³•åˆ·æ–°ï¼šå…ƒç´ æœªå®šä¹‰æˆ– setScene ä¸å¯ç”¨");
            }
        }

        function clearCanvas() {
            const canvas = document.getElementById("iconCanvas");
            const ctx = canvas.getContext("2d");

            // æ¸…é™¤å›¾åƒå†…å®¹
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // é‡ç½®ç»˜å›¾çŠ¶æ€
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.fillStyle = "#000000";
            ctx.strokeStyle = "#000000";
            ctx.lineWidth = 1;
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = "source-over";

            // âœ… å…ˆåœæ­¢åŠ¨ç”»ï¼Œå†æ¸…ç©ºå…ƒç´ 
            stopAllAnimations();

            elements.length = 0;
            selectedIndex = null;
            selectedIndices = [];
            dragIndex = null;

            console.log("ğŸ§¹ ç”»å¸ƒå’Œå…ƒç´ å·²å½»åº•æ¸…ç©º");
        }
        function loadSceneData(data) {
            // è¿™é‡Œå¤„ç† JSON æ•°æ®å¹¶æ¸²æŸ“åˆ° canvas ä¸Š
            console.log("è½½å…¥çš„åœºæ™¯æ•°æ®:", data);
            // ä½ è‡ªå®šä¹‰çš„ç»˜åˆ¶é€»è¾‘åº”åœ¨è¿™é‡Œå¤„ç† data
        }

        function loadSceneByName(name) {
            stopAllAnimations();
            const fileUrl = `sample/${name}.json`;
            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error("ç½‘ç»œé”™è¯¯æˆ–æ–‡ä»¶ä¸å­˜åœ¨");
                    return response.json();
                })
                .then(data => {
                    const loadedElements = Array.isArray(data)
                        ? data
                        : Array.isArray(data.elements)
                            ? data.elements
                            : [];

                    if (loadedElements.length === 0) {
                        alert("âš ï¸ åœºæ™¯æ•°æ®ä¸ºç©º");
                        return;
                    }

                    setScene(loadedElements);      // âœ… åˆå§‹åŒ–åœºæ™¯
                    saveInitialStates();           // âœ… è®°å½•åˆå§‹çŠ¶æ€

                })
                .catch(error => {
                    console.error("è½½å…¥åœºæ™¯å¤±è´¥:", error);
                });
        }
        document.addEventListener('keydown', event => {
            switch (event.key) {
                case '1': saveInitialStates(); break;
                case '2': restoreInitialStates(); break;
                case '3': animateMoveForSelected(); break;
                case '4': startSwingForSelected(); break;
                case '5': startRotationForSelected(); break;
                case '6': startScaleForSelected(); break;
                case '7': flipSelfHorizontal(); break;
                case '8': fillSelectedElement(); break;
                case '9': stopAnimationForSelected(); break;
            }
        });
        window.addEventListener("DOMContentLoaded", () => {
            loadSceneByName("food"); // âœ… é»˜è®¤è½½å…¥ç¾é£Ÿå›¾é‰´
        });
    </script>
    <script>
        document.getElementById("material").addEventListener("click", () => {
            window.open("https://aj300542.github.io/emoji/index2.html", "_blank");
        });
        document.getElementById("aj300").addEventListener("click", () => {
            window.open("https://aj300542.github.io/download.html", "_blank");
        });
    </script>
</body>

</html>